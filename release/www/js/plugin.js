"use strict";angular.module("owsWalletPlugin",["gettext","ngLodash","owsWalletPluginClient","owsWalletPlugin.apiHandlers","owsWalletPlugin.services"]),angular.module("owsWalletPlugin.apiHandlers",[]),angular.module("owsWalletPlugin.services",[]),angular.module("owsWalletPlugin").config(["$pluginConfigProvider",function($pluginConfigProvider){$pluginConfigProvider.router.routes([{path:"/accounts/:accountId?",method:"GET",handler:"getAccounts"},{path:"/accounts/:accountId/addresses",method:"POST",handler:"createAddress"},{path:"/accounts/:accountId/buys",method:"POST",handler:"requestBuy"},{path:"/accounts/:accountId/sells",method:"POST",handler:"requestSell"},{path:"/accounts/:accountId/transactions",method:"GET",handler:"getAccountTransactions"},{path:"/exchange-rates/:currency?",method:"GET",handler:"getExchangeRates"},{path:"/paymentMethods/:paymentMethodId?",method:"GET",handler:"getPaymentMethods"},{path:"/prices",method:"GET",handler:"getPriceInfo"},{path:"/prices/buy/:currency",method:"GET",handler:"getBuyPrice"},{path:"/prices/historic/:currencyPair/:period",method:"GET",handler:"getHistoricPrice"},{path:"/prices/sell/:currency",method:"GET",handler:"getSellPrice"},{path:"/prices/spot",method:"GET",handler:"getSpotPrice"},{path:"/service",method:"PUT",handler:"service"},{path:"/transactions/pending",method:"GET",handler:"getPendingTransactions"},{path:"/transactions/pending",method:"POST",handler:"savePendingTransactions"},{path:"/urls",method:"GET",handler:"getUrls"},{path:"/user",method:"GET",handler:"getCurrentUser"}])}]).run(function(){owswallet.Plugin.ready(function(){})}),angular.module("owsWalletPlugin").run(["gettextCatalog",function(gettextCatalog){}]),angular.module("owsWalletPlugin.services").factory("coinbaseService",["$rootScope","$log","lodash","owsWalletPluginClient.api.Host","owsWalletPluginClient.api.Http","owsWalletPluginClient.api.Session","owsWalletPluginClient.api.Settings","owsWalletPluginClient.api.Storage",function($rootScope,$log,lodash,Host,Http,Session,Settings,Storage){function setCredentials(config){credentials.SCOPE="wallet:accounts:read,wallet:addresses:read,wallet:addresses:create,wallet:user:read,wallet:user:email,wallet:buys:read,wallet:buys:create,wallet:sells:read,wallet:sells:create,wallet:transactions:read,wallet:transactions:send,wallet:payment-methods:read,wallet:payment-methods:limits",credentials.REDIRECT_URI=isCordova?config.redirect_uri.mobile:config.redirect_uri.desktop,credentials.HOST=config.production.host,credentials.API=config.production.api,credentials.CLIENT_ID=config.production.client_id,credentials.CLIENT_SECRET=config.production.client_secret,credentials.API_VERSION="2018-01-06",createCoinbaseHostProvider()}function createCoinbaseHostProvider(){coinbaseHost=new Http(credentials.HOST,{headers:{"Content-Type":"application/json",Accept:"application/json"}})}function createCoinbaseApiProvider(accessToken){coinbaseApi=new Http(credentials.API+"/v2/",{headers:{"Content-Type":"application/json",Accept:"application/json","CB-VERSION":credentials.API_VERSION,Authorization:"Bearer "+accessToken}},oauthRefresh)}function updateCoinbaseApiProviderAuthorization(apiProvider,accessToken){apiProvider.setHeaders({Authorization:"Bearer "+accessToken})}function oauthRefresh(httpProvider,response){return new Promise(function(resolve,reject){var error=response.data;if(!error.errors||error.errors&&!lodash.isArray(error.errors))return reject(response);var oauthError=lodash.intersectionWith(oauthErrors,error.errors,function(val1,val2){return val1.coinbaseId==val2.id});if(!(oauthError.length>0))return reject(response);switch(oauthError=oauthError[0],oauthError.coinbaseId){case"expired_token":$log.info(oauthError.message+": refreshing access token"),refreshToken().then(function(newAccessToken){return updateCoinbaseApiProviderAuthorization(httpProvider,newAccessToken),resolve()}).catch(function(error){return $log.warn("Failed to refresh token, logging out"),root.logout(oauthError.statusText),reject({data:{errors:[{id:oauthError.coinbaseId,message:oauthError.message+": "+error,statusCode:oauthError.statusCode,statusText:oauthError.statusText}]}})});break;case"revoked_token":case"invalid_token":case"invalid_grant":return $log.warn(oauthError.message+": logging out"),root.logout(oauthError.statusText),reject({data:{errors:[{id:oauthError.coinbaseId,message:oauthError.message,statusCode:oauthError.statusCode,statusText:oauthError.statusText}]}});default:return reject(response)}})}function getToken(oauthCode){return new Promise(function(resolve,reject){var data={grant_type:"authorization_code",code:oauthCode,client_id:credentials.CLIENT_ID,client_secret:credentials.CLIENT_SECRET,redirect_uri:credentials.REDIRECT_URI};coinbaseHost.post("oauth/token/",data).then(function(response){var data=response.data;if(!(data&&data.access_token&&data.refresh_token))return reject(getError("No access token in response","getToken"));saveToken(data.access_token,data.refresh_token,function(error,accessToken){return error?reject(getError("Could not save the access token","getToken")):(createCoinbaseApiProvider(accessToken),resolve())})}).catch(function(response){reject(getError(response,"getToken"))})})}function getTokenFromStorage(){return new Promise(function(resolve,reject){storage.getAccessToken().then(function(accessToken){resolve(accessToken)}).catch(function(error){reject(getError(response,"getTokenFromStorage"))})})}function saveToken(accessToken,refreshToken,cb){storage.setAccessToken(accessToken).then(function(){return storage.setRefreshToken(refreshToken)}).then(function(){return cb(null,accessToken)}).catch(function(error){return $log.error("Coinbase: saveToken "+error),cb(error)})}function refreshToken(){return new Promise(function(resolve,reject){storage.getRefreshToken().then(function(refreshToken){var data={grant_type:"refresh_token",client_id:credentials.CLIENT_ID,client_secret:credentials.CLIENT_SECRET,redirect_uri:credentials.REDIRECT_URI,refresh_token:refreshToken};coinbaseHost.post("oauth/token/",data).then(function(response){var data=response.data;if(!(data&&data.access_token&&data.refresh_token))return reject(getError("Could not get the access token","refreshToken"));saveToken(data.access_token,data.refresh_token,function(accessToken){return createCoinbaseApiProvider(accessToken),$log.info("Successfully refreshed token from Coinbase"),resolve(accessToken)})}).catch(function(response){return reject(getError(response,"refreshToken"))})}).catch(function(error){return reject(getError("Could not get refresh token from storage: "+error),"refreshToken")})})}function getUrls(){return{oauthCodeUrl:credentials.HOST+"/oauth/authorize?response_type=code&account=all&client_id="+credentials.CLIENT_ID+"&redirect_uri="+credentials.REDIRECT_URI+"&state=SECURE_RANDOM&scope="+credentials.SCOPE+"&meta[send_limit_amount]=1&meta[send_limit_currency]=USD&meta[send_limit_period]=day",signupUrl:"https://www.coinbase.com/signup",supportUrl:"https://support.coinbase.com",privacyUrl:"https://www.coinbase.com/legal/user_agreement"}}function updatePendingTransactions(obj){for(var i=1;i<arguments.length;i++)for(var prop in arguments[i]){var val=arguments[i][prop];"object"==typeof val?updatePendingTransactions(obj[prop],val):obj[prop]=val||obj[prop]}return obj}function fetchPendingTransactions(){return lodash.throttle(function(){$log.debug("Updating coinbase pending transactions...");var pendingTransactions={data:{}};root.getPendingTransactions(pendingTransactions)},2e4)}function refreshTransactions(pendingTransactions){storage.getTxs().then(function(txs){txs=txs?JSON.parse(txs):{},pendingTransactions.data=lodash.isEmpty(txs)?null:txs}).catch(function(error){$log.error(error)})}function sellPending(tx,accountId,pendingTransactions,cb){var data=tx.amount;data.payment_method=tx.payment_method||null,data.commit=!0,root.sellRequest(accountId,data).then(function(res){res.data&&!res.data.transaction?root.savePendingTransaction(tx,{status:"error",error:{errors:[{message:"Sell order: transaction not found."}]}},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions),cb(pendingTransactions)}):root.getTransaction(accountId,res.data.transaction.id).then(function(updatedTx){root.savePendingTransaction(tx,{remove:!0},function(err){root.savePendingTransaction(updatedTx.data,{},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions),cb(pendingTransactions)})})}).catch(function(error){root.savePendingTransaction(tx,{status:"error",error:error},function(error){error&&$log.error(error),refreshTransactions(pendingTransactions),cb(pendingTransactions)})})}).catch(function(error){root.savePendingTransaction(tx,{status:"error",error:error},function(error){error&&$log.debug(error),refreshTransactions(pendingTransactions),cb(pendingTransactions)})})}function sendToWallet(tx,accountId,pendingTransactions){var desc=Host.nameCase+" Wallet";getNetAmount(tx.amount.amount,function(err,amountBTC,feeBTC){if(err)return void root.savePendingTransaction(tx,{status:"error",error:{errors:[{message:err}]}},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions)});var data={to:tx.toAddr,amount:amountBTC,currency:tx.amount.currency,description:desc,fee:feeBTC};root.sendTo(accountId,data).then(function(res){if(res.data&&!res.data.id)return void root.savePendingTransaction(tx,{status:"error",error:{errors:[{message:"Transactions not found in Coinbase.com"}]}},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions)});root.getTransaction(accountId,res.data.id).then(function(sendTx){root.savePendingTransaction(tx,{remove:!0},function(err){err&&$log.error(err),root.savePendingTransaction(sendTx.data,{},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions)})})})}).catch(function(error){root.savePendingTransaction(tx,{status:"error",error:error},function(error){error&&$log.debug(error),refreshTransactions(pendingTransactions)})})})}function getNetAmount(amount,cb){feeService.getFeeRate("btc","livenet","normal",function(err,feePerKb){if(err)return cb("Could not get fee rate");var feeBTC=(.45*feePerKb/1e8).toFixed(8);return cb(null,amount-feeBTC,feeBTC)})}function getError(response,callerId){if(response.message)return{id:"unexpected_error",message:response.message};$log.error("Coinbase: "+callerId+" - "+getErrorsAsString(response.data));if(!(response.status&&response.status<=0))return response.data.error?{id:response.data.error,message:response.data.error_description}:response.data.errors&&lodash.isArray(response.data.errors)?response.data.errors[0]:response.data?response.data:{id:"unexpected_error",message:response.toString()}}function getErrorsAsString(data){var errData;try{if(data&&data.errors)errData=data.errors;else{if(!data||!data.error)return"Unknown error";errData=data.error_description}if(lodash.isArray(errData)){for(var errStr="",i=0;i<errData.length;i++)errStr=errStr+errData[i].message+". ";errData=errStr}else errData=errData&&errData.message?errData.message:errData;return errData}catch(e){$log.error(e)}}var storage,coinbaseApi,coinbaseHost,root={},isCordova=owswallet.Plugin.isCordova(),session=Session.getInstance(),credentials={},currencies=[{pair:"BTC-USD",label:"Bitcoin"},{pair:"BCH-USD",label:"Bitcoin Cash"},{pair:"ETH-USD",label:"Ether"},{pair:"LTC-USD",label:"Litecoin"}],oauthErrors=[{coinbaseId:"expired_token",message:"Token expired",statusCode:401,statusText:"UNAUTHORIZED_EXPIRED"},{coinbaseId:"revoked_token",message:"Token revoked",statusCode:401,statusText:"UNAUTHORIZED_REVOKED"},{coinbaseId:"invalid_token",message:"Token invalid",statusCode:401,statusText:"UNAUTHORIZED_INVALID"},{coinbaseId:"invalid_grant",message:"Authorization grant is invalid",statusCode:401,statusText:"UNAUTHORIZED_GRANT"}];return owswallet.Plugin.onEvent("host.new-block",function(event){var network=lodash.get(event,"event.n.data.network");"NewBlock"==event.type&&network.indexOf("livenet")>=0&&fetchPendingTransactions()}),root.init=function(clientId,config,oauthCode){return new Promise(function(resolve,reject){if(!config){var error="Could not initialize API service: no plugin configuration provided";$log.error(error),reject(error)}setCredentials(config),storage=new Storage(["access-token","refresh-token","txs"],clientId);var info={};info.urls=getUrls(),oauthCode?getToken(oauthCode).then(function(){return resolve({info:info})}).catch(function(error){var oauthError=lodash.intersectionWith(oauthErrors,[error],function(val1,val2){return val1.coinbaseId==val2.id});return oauthError?(oauthError=oauthError[0],reject({id:oauthError.coinbaseId,message:oauthError.message,statusCode:oauthError.statusCode,statusText:oauthError.statusText})):reject(error)}):getTokenFromStorage().then(function(accessToken){return createCoinbaseApiProvider(accessToken),resolve({info:info})})})},root.logout=function(reason){return new Promise(function(resolve,reject){storage.removeAccessToken().then(function(){return storage.removeRefreshToken()}).then(function(){return storage.removeTxs()}).then(function(){$log.info("Logged out of Coinbase."),session.broadcastEvent("coinbase.logout",{reason:reason||"USER_REQUESTED"}),resolve()}).catch(function(error){$log.error("Could not logout: "+error),reject(error)})})},root.getStorage=function(){return storage},root.getExchangeRates=function(currency){return new Promise(function(resolve,reject){coinbaseApi.get("exchange-rates?currency="+currency).then(function(response){var data=response.data.data.rates;resolve(data)}).catch(function(response){reject(getError(response,"getExchangeRates"))})})},root.getAccounts=function(accountId){return new Promise(function(resolve,reject){coinbaseApi.get("accounts/"+(accountId||"")).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"getAccounts"))})})},root.getCurrentUser=function(){return new Promise(function(resolve,reject){coinbaseApi.get("user/").then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"getCurrentUser"))})})},root.getUserAuth=function(){return new Promise(function(resolve,reject){coinbaseApi.get("user/auth").then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"getUserAuth"))})})},root.getBuyOrder=function(accountId,buyId){return new Promise(function(resolve,reject){coinbaseApi.get("accounts/"+accountId+"/buys/"+buyId).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"getBuyOrder"))})})},root.getTransaction=function(accountId,transactionId){return new Promise(function(resolve,reject){coinbaseApi.get("accounts/"+accountId+"/transactions/"+transactionId).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"getTransaction"))})})},root.getTransactions=function(accountId){return new Promise(function(resolve,reject){coinbaseApi.get("accounts/"+accountId+"/transactions").then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"getTransactions"))})})},root.sellPrice=function(currency){return new Promise(function(resolve,reject){coinbaseApi.get("prices/sell?currency="+currency).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"sellPrice"))})})},root.buyPrice=function(currency){return new Promise(function(resolve,reject){coinbaseApi.get("prices/buy?currency="+currency).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"buyPrice"))})})},root.spotPrice=function(){return new Promise(function(resolve,reject){var count=currencies.length,result={};lodash.forEach(currencies,function(c){coinbaseApi.get("prices/"+c.pair+"/spot").then(function(response){result[c.pair]=response.data.data,result[c.pair].label=c.label,0==--count&&resolve(result)}).catch(function(response){getError(response,"spotPrice"),result[c.pair]={},result[c.pair].error=error.message,0==--count&&resolve(result)})})})},root.historicPrice=function(currencyPair,period){return new Promise(function(resolve,reject){coinbaseApi.get("prices/"+currencyPair+"/historic?period="+period).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"historicPrice"))})})},root.getPaymentMethods=function(paymentMethodId){return new Promise(function(resolve,reject){coinbaseApi.get("payment-methods/"+(paymentMethodId||"")).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"getPaymentMethods"))})})},root.sellRequest=function(accountId,requestData){return new Promise(function(resolve,reject){var data={amount:requestData.amount,currency:requestData.currency,payment_method:requestData.payment_method||null,commit:requestData.commit||!1,quote:requestData.quote||!1};coinbaseApi.post("accounts/"+accountId+"/sells",data).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"sellRequest"))})})},root.buyRequest=function(accountId,requestData){return new Promise(function(resolve,reject){var data={amount:requestData.amount,currency:requestData.currency,paymentMethodId:requestData.paymentMethodId||null,commit:requestData.commit||!1,quote:requestData.quote||!1};coinbaseApi.post("accounts/"+accountId+"/buys",data).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"buyRequest"))})})},root.createAddress=function(accountId,addressData){return new Promise(function(resolve,reject){var data={name:addressData.name};coinbaseApi.post("accounts/"+accountId+"/addresses",data).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"createAddress"))})})},root.sendTo=function(accountId,sendData){return new Promise(function(resolve,reject){var data={type:"send",to:sendData.to,amount:sendData.amount,currency:sendData.currency,description:sendData.description};coinbaseApi.post("accounts/"+accountId+"/transactions",data).then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"sendTo"))})})},root.getAccountTransactions=function(accountId){return new Promise(function(resolve,reject){coinbaseApi.get("accounts/"+accountId+"/transactions").then(function(response){var data=response.data.data;resolve(data)}).catch(function(response){reject(getError(response,"getAccountTransactions"))})})},root.getPendingTransactions=function(pendingTransactions){return new Promise(function(resolve,reject){storage.getTxs().then(function(txs){return txs=txs?JSON.parse(txs):{},pendingTransactions.data=lodash.isEmpty(txs)?null:txs,lodash.forEach(pendingTransactions.data,function(dataFromStorage,txId){"sell"==dataFromStorage.type&&"completed"==dataFromStorage.status||"buy"==dataFromStorage.type&&"completed"==dataFromStorage.status||"error"==dataFromStorage.status||"send"==dataFromStorage.type&&"completed"==dataFromStorage.status||root.getTransaction(accountId,txId,function(err,tx){if(err||lodash.isEmpty(tx)||tx.data&&tx.data.error)return void root.savePendingTransaction(dataFromStorage,{status:"error",error:tx.data&&tx.data.error?tx.data.error:err},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions)});if(updatePendingTransactions(dataFromStorage,tx.data),pendingTransactions.data[txId]=dataFromStorage,"send"==tx.data.type&&"completed"==tx.data.status&&tx.data.from)root.sellPrice(dataFromStorage.sell_price_currency).then(function(s){var newSellPrice=s.data.amount;Math.abs((newSellPrice-dataFromStorage.sell_price_amount)/dataFromStorage.sell_price_amount*100)<dataFromStorage.price_sensitivity.value?sellPending(dataFromStorage,accountId,pendingTransactions,function(pendingTransactions){}):root.savePendingTransaction(dataFromStorage,{status:"error",error:{errors:[{message:"Price falls over the selected percentage"}]}},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions)})}).catch(function(error){root.savePendingTransaction(dataFromStorage,{status:"error",error:error},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions)})});else{if("buy"==tx.data.type&&"completed"==tx.data.status&&tx.data.buy)return void(dataFromStorage&&sendToWallet(dataFromStorage,accountId,pendingTransactions));root.savePendingTransaction(dataFromStorage,{},function(err){err&&$log.debug(err),refreshTransactions(pendingTransactions)})}})}),resolve(pendingTransactions)})})},root.savePendingTransaction=function(ctx,opts,cb){storage.getTxs().then(function(oldTxs){lodash.isString(oldTxs)&&(oldTxs=JSON.parse(oldTxs)),lodash.isString(ctx)&&(ctx=JSON.parse(ctx));var tx=oldTxs||{};return tx[ctx.id]=ctx,opts&&(opts.error||opts.status)&&(tx[ctx.id]=lodash.assign(tx[ctx.id],opts)),opts&&opts.remove&&delete tx[ctx.id],tx=JSON.stringify(tx),storage.setTxs(tx)}).catch(function(error){return cb(error)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("createAddress",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var accountId=message.request.params.accountId,data=message.request.data;if(!accountId)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide accountId."}},callback(message);coinbaseService.createAddress(accountId,data).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getAccounts",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var accountId=message.request.params.accountId;coinbaseService.getAccounts(accountId).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getAccountTransactions",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var accountId=message.request.params.accountId;if(!accountId)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide accountId."}},callback(message);coinbaseService.getAccountTransactions(accountId).then(function(transactions){return message.response={statusCode:200,statusText:"OK",data:transactions},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getBuyPrice",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var currency=message.request.params.currency;if(!currency)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide currency."}},callback(message);coinbaseService.buyPrice(currency).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getCurrentUser",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var data={user:{},auth:{}};coinbaseService.getCurrentUser().then(function(response){data.user=response,coinbaseService.getUserAuth().then(function(response){return data.auth=response,message.response={statusCode:200,statusText:"OK",data:data},callback(message)})}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getExchangeRates",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var currency=message.request.params.currency;coinbaseService.getExchangeRates(currency).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getHistoricPrice",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var currencyPair=message.request.params.currencyPair,period=message.request.params.period;if(!currencyPair)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide currencyPair."}},callback(message);coinbaseService.historicPrice(currencyPair,period).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getPaymentMethods",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var paymentMethodId=message.request.params.paymentMethodId;coinbaseService.getPaymentMethods(paymentMethodId).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getPendingTransactions",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var pendingTransactions={data:{}};coinbaseService.getPendingTransactions(pendingTransactions).then(function(pendingTransactions){return message.response={statusCode:200,statusText:"OK",data:pendingTransactions},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getSellPrice",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var currency=message.request.params.currency;if(!currency)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide currency."}},callback(message);coinbaseService.sellPrice(currency).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getSpotPrice",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){coinbaseService.spotPrice().then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getTransactions",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var accountId=message.request.params.accountId,transactionId=message.request.params.transactionId;if(!accountId)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide accountId."}},callback(message);transactionId?coinbaseService.getTransaction(accountId,transactionId).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)}):coinbaseService.getTransactions(accountId).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("getUrls",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){return message.response={statusCode:200,statusText:"OK",data:coinbaseService.getUrls()},callback(message)},root}]),angular.module("owsWalletPlugin.apiHandlers").service("requestBuy",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var accountId=message.request.params.accountId,data=message.request.data;if(!accountId)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide accountId."}},callback(message);coinbaseService.buyRequest(accountId,data).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("requestSell",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var accountId=message.request.params.accountId,data=message.request.data;if(!accountId)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide accountId."}},callback(message);coinbaseService.sellRequest(accountId,data).then(function(response){return message.response={statusCode:200,statusText:"OK",data:response},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)})},root}]),angular.module("owsWalletPlugin.apiHandlers").service("savePendingTransaction",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var tx=message.request.data.tx,options=message.request.data.options;if(!tx)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide tx."}},callback(message);coinbaseService.savePendingTransaction(tx,options,function(error){return error?(message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)):(message.response={statusCode:200,statusText:"OK",data:{}},callback(message))})},root}]),
angular.module("owsWalletPlugin.apiHandlers").service("service",["coinbaseService",function(coinbaseService){var root={};return root.respond=function(message,callback){var clientId=message.header.clientId,state=message.request.data.state,oauthCode=message.request.data.oauthCode,pluginConfig=message.request.data.config;if(!state||!clientId)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required data, must provide state."}},callback(message);switch(state){case"initialize":if(!pluginConfig)return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Missing required configuration."}},callback(message);coinbaseService.init(clientId,pluginConfig,oauthCode).then(function(data){return message.response={statusCode:200,statusText:"OK",data:data},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)});break;case"logout":coinbaseService.logout().then(function(){return message.response={statusCode:200,statusText:"OK",data:{}},callback(message)}).catch(function(error){return message.response={statusCode:error.statusCode||500,statusText:error.statusText||"UNEXPECTED_ERROR",data:{message:error.message}},callback(message)});break;default:return message.response={statusCode:500,statusText:"REQUEST_NOT_VALID",data:{message:"Unrecognized state."}},callback(message)}},root}]);